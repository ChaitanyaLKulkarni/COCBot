name: CI

on:
    push:
        branches: main
    pull_request:
        branches: main

jobs:
    build:
        runs-on: ubuntu-latest
        env:
            working-directory: ./client
        strategy:
            matrix:
                node-version: [12]

        steps:
            - name: Checkout repository
              uses: actions/checkout@v2

            - name: Set up Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v1
              with:
                  node-version: ${{ matrix.node-version }}

            - name: Install dependencies
              run: npm install
              working-directory: ${{env.working-directory}}

            - name: Build
              run: npm run build
              working-directory: ${{env.working-directory}}

            - name: Push build
              run: |
                  git_setup() {
                    cat <<- EOF > $HOME/.netrc
                      machine github.com
                      login $GITHUB_ACTOR
                      password $GITHUB_TOKEN
                      machine api.github.com
                      login $GITHUB_ACTOR
                      password ${{ secrets.GITHUB_TOKEN }}
                  EOF
                    chmod 600 $HOME/.netrc

                    git config --global user.email "$GITHUB_ACTOR@users.noreply.github.com"
                    git config --global user.name "$GITHUB_ACTOR"
                  }

                  git_setup
                  git remote update
                  git fetch --all
                  git remote update
                  
                  git stash

                  # Will create branch if it does not exist
                  if [[ $( git branch -r | grep "build" ) ]]; then
                     git checkout "build"
                  else
                     git checkout -b "build"
                  fi

                  git stash pop
                  git rm -r -f --cached
                  git rm -r -f *
                  git add .
                  git add -f ./client/build 
                  git commit -m "Auto Build"
                  git push origin "build"
